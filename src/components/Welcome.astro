---
import astroLogo from '../assets/astro.svg';
import background from '../assets/background.svg';
//if(cookies.get('registrationId')) {
	//window.location.href = '/dashboard';
//}
---

<div id="container">
<img id="background" src={background} alt="" loading="lazy" aria-hidden="true" />

<main>
	<section id="hero">

		<h1>Register for Green Career Fair 2025</h1>
		<p>Sign up with your university details to get access.</p>

		<form id="registerForm" class="box" method="post" action="#" aria-label="University registration form">
			<label for="name">Full name</label>
			<input id="name" name="name" type="text" placeholder="Jane Doe" required />

			<label for="email">University email</label>
			<input id="email" name="email" type="email" placeholder="name@university.edu" required pattern=".+@.+\..+" />

			<label for="course">Course</label>
			<input id="course" name="course" type="text" placeholder="BSc Computer Science" required />

			<label for="gradYear">Graduation year</label>
			<input id="gradYear" name="gradYear" type="number" min="2023" max="2100" step="1" placeholder="2026" required />

			<div id="links">
				<button id="submitBtn" type="submit" class="button" aria-label="Register">Register</button>
			</div>

			<div id="status" role="status" aria-live="polite" style="margin-top:12px;"></div>
		</form>
	</section>
</main>

<script type="module">
	// Redirect to dashboard on client if registrationId cookie is present
	if (typeof document !== 'undefined' && document.cookie.split('; ').some(c => c.trim().startsWith('registrationId='))) {
		window.location.href = '/dashboard';
	}

	const form = document.getElementById('registerForm');
	const statusEl = document.getElementById('status');
	const submitBtn = document.getElementById('submitBtn');

	form.addEventListener('submit', async (e) => {
		e.preventDefault();
		statusEl.textContent = '';
		submitBtn.disabled = true;

		const fd = new FormData(form);
		const payload = {
			name: fd.get('name')?.toString() || '',
			email: fd.get('email')?.toString() || '',
			course: fd.get('course')?.toString() || '',
			gradYear: fd.get('gradYear')?.toString() || '',
		};

		try {
			const res = await fetch('/api/register', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload),
			});

			if (res.ok) {

			
				// parse response and store auto id in localStorage if present
				const data = await res.json().catch(() => null);	console.log(data.data.id);
				const id = String(data.data?.id ?? data.id ?? data.ID ?? data._id);
						console.log('Storing registration ID in cookie:', id);
						const maxAge = 60 * 60 * 24 * 30; // 30 days
						document.cookie = `registrationId=${encodeURIComponent(id)}; path=/; max-age=${maxAge}; SameSite=Lax; Secure`;
				const email = String(data.data?.email ?? data.id ?? data.ID ?? data._id);
						console.log('Storing registration ID in cookie:', id);
					
						document.cookie = `email=${encodeURIComponent(email)}; path=/; max-age=${maxAge}; SameSite=Lax; Secure`;
			
				
			}

			if (!res.ok) {
				const err = await res.json().catch(() => ({ message: res.statusText }));
				statusEl.textContent = 'Registration failed: ' + (err.message || res.statusText);
				statusEl.style.color = 'crimson';
			} else {
				statusEl.textContent = 'Registration successful. Check your email for next steps.';
				statusEl.style.color = 'green';
				window.location.href = '/dashboard';
				form.reset();
			}
		} catch (error) {
			statusEl.textContent = 'Network error. Please try again.';
			statusEl.style.color = 'crimson';
		} finally {
			submitBtn.disabled = false;
		}
	});
</script>
<style>
:global(body) {
	margin: 0;
	font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
	background-color: #f2f5f1;
	color: #0f2412;
}

#container {
	min-height: 100vh;
	position: relative;
	overflow: hidden;
}

#background {
	position: fixed;
	inset: 0;
	width: 100%;
	height: 100%;
	opacity: 0.15;
	object-fit: cover;
	z-index: -1;
}

main {
	min-height: 100vh;
	display: flex;
	justify-content: center;
	align-items: center;
	padding: 4rem 1rem;
}

#hero {
	max-width: 520px;
	width: 100%;
}

form {
	display: flex;
	flex-direction: column;
	gap: 0.75rem;
	background: #fff;
	border-radius: 1.25rem;
	padding: 2rem;
	box-shadow: 0 20px 60px rgba(3, 32, 15, 0.12);
}

label {
	font-weight: 600;
	color: #1a2e22;
}

input {
	border: 1px solid #cad6c9;
	border-radius: 0.75rem;
	padding: 0.9rem 1rem;
	font-size: 1rem;
	background: #f9fbf8;
}

input:focus {
	outline: 2px solid #1f8a4d;
	background: #fff;
}

#links {
	display: flex;
	justify-content: flex-end;
}

.button {
	background: #1f8a4d;
	color: #fff;
	border: none;
	border-radius: 999px;
	padding: 0.85rem 1.75rem;
	font-size: 1rem;
	font-weight: 600;
	cursor: pointer;
	transition: background 160ms ease;
}

.button:disabled {
	opacity: 0.6;
	cursor: not-allowed;
}

.button:not(:disabled):hover {
	background: #17673a;
}

#status {
	font-weight: 600;
}

@media (max-width: 600px) {
	main {
		padding: 2rem 1.25rem;
	}

	form {
		padding: 1.5rem;
	}
}
</style>
</div>
