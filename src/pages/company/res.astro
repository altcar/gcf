---
---
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>qr-scanner Demo</title>
  <!-- <link rel="stylesheet" href="./style.css"> -->
</head>
<body>
  <main class="wrap">
    <h2>RES</h2>

    <div class="controls">
      <button id="startBtn">Start camera</button>
      <button id="switchBtn" disabled>Switch camera</button>
      <button id="flashBtn" disabled>Toggle flash</button>
      <button id="stopBtn" disabled>Stop</button>
      <label class="file">
        <input id="fileInput" type="file" accept="image/*" />
        <span>Scan from image…</span>
      </label>
    </div>

    <div class="stage">
      <video id="video" playsinline muted></video>
      <!-- qr-scanner can render its own overlays if enabled -->
      <div id="overlayContainer"></div>
    </div>

    <p class="result"><strong>Result:</strong> <span id="result">—</span></p>
  </main>

  <script type="module">
    import QrScanner from 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js';

    const video = document.getElementById('video');
    const overlayContainer = document.getElementById('overlayContainer');
    const resultEl = document.getElementById('result');

    const startBtn = document.getElementById('startBtn');
    const switchBtn = document.getElementById('switchBtn');
    const flashBtn = document.getElementById('flashBtn');
    const stopBtn = document.getElementById('stopBtn');
    const fileInput = document.getElementById('fileInput');

    let facingMode = 'environment'; // 'user'
    let qrScanner = null;

    function setButtons(state) {
      const running = state === 'running';
      startBtn.disabled = running;
      switchBtn.disabled = !running;
      stopBtn.disabled = !running;
      // flashBtn gets enabled dynamically after start() if supported
    }

    function makeScanner() {
      if (qrScanner) {
        qrScanner.stop();
      }
      qrScanner = new QrScanner(
        video,
        (result) => {
          console.log('decoded qr code:', result);

          (async () => {
            try {


              const payload = typeof result === 'string' ? { data: result } : result;
                payload.companyname = 'company6';
              console.log(payload)
              const resp = await fetch('/api/company', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              });
              if (!resp.ok) {
                const txt = await resp.text();
                console.error('POST /api/chocolate failed:', resp.status, txt);
              } else {
                const json = await resp.json().catch(() => null);
                console.log('Posted scan to /api/chocolate:', json ?? 'no-json');

                // create a simple modal to show the response JSON
                (function showScanModal(payload) {
                  const content = payload ? JSON.stringify(payload, null, 2) : 'no-json';

                  function escapeHtml(str) {
                    return String(str)
                      .replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;');
                  }

                  const existing = document.getElementById('scan-result-modal');
                  if (existing) existing.remove();

                  const modal = document.createElement('div');
                  modal.id = 'scan-result-modal';
                  modal.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:9999;';
                  modal.innerHTML = `
                    <div role="dialog" aria-modal="true" style="background:#fff;color:#000;padding:1rem;border-radius:8px;max-width:90vw;max-height:80vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.3);">
                      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
                        <strong>Scan result</strong>
                        <button id="scan-result-close" style="background:#0057e7;color:#fff;border:none;padding:.25rem .5rem;border-radius:4px;cursor:pointer">Close</button>
                      </header>
                      <pre style="white-space:pre-wrap;margin:0;font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9rem;">${escapeHtml(content)}</pre>
                    </div>
                  `;
                  document.body.appendChild(modal);

                  document.getElementById('scan-result-close').addEventListener('click', () => modal.remove());
                  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
                })(json);
              }
            } catch (err) {
              console.error('Error posting scan result:', err);
            }




          })();
          // stop(); // stop scanning after first result
          // If options are provided, result is an object with { data, cornerPoints }
          resultEl.textContent = typeof result === 'string' ? result : result.data;
        },
        {
          preferredCamera: facingMode,           // 'environment' or 'user'
          highlightScanRegion: true,             // draw the scan region
          highlightCodeOutline: true,            // draw outline on detected code
          returnDetailedScanResult: true,        // ensure { data, cornerPoints }
        }
      );
    }

    async function start() {
      try {
        if (!qrScanner) makeScanner();
        await qrScanner.start(); // prompts for permission if needed

        // Enable/disable flash button depending on support
        const hasFlash = await qrScanner.hasFlash();
        flashBtn.disabled = !hasFlash;

        setButtons('running');
      } catch (e) {
        console.error(e);
        alert('Could not start the camera. Ensure https:// or http://localhost and grant camera access.');
      }
    }

    async function stop() {
      if (qrScanner) await qrScanner.stop();
      setButtons('idle');
      flashBtn.disabled = true;
    }

    async function switchCamera() {
      facingMode = (facingMode === 'environment') ? 'user' : 'environment';
      makeScanner();
      await start();
    }

    async function toggleFlash() {
      try {
        const on = await qrScanner.isFlashOn();
        await qrScanner.turnFlash(!on);
      } catch {
        // Ignore if not supported
      }
    }

    // Scan a still image
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const res = await QrScanner.scanImage(file, { returnDetailedScanResult: true });
        resultEl.textContent = res.data;
      } catch {
        resultEl.textContent = 'No QR found in image';
      }
    });

    // Wire up UI
    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
    switchBtn.addEventListener('click', switchCamera);
    flashBtn.addEventListener('click', toggleFlash);

    // Initialize UI
    setButtons('idle');
  </script>






<style>
  :root { --w: min(92vw, 720px); }

body {
  font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  margin: 0;
  padding: 2rem;
  background: #fafafa;
  color: #222;
}

.wrap {
  margin: 0 auto;
  width: var(--w);
}

h2 {
  margin-bottom: 1rem;
  font-size: 1.5rem;
  font-weight: 600;
}

.controls {
  display: flex;
  gap: .5rem;
  flex-wrap: wrap;
  margin-bottom: .75rem;
}

button, .file {
  padding: .5rem .75rem;
  border: none;
  border-radius: 6px;
  background: #0057e7;
  color: white;
  cursor: pointer;
  font-size: .9rem;
  transition: background .2s;
}

button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

button:hover:enabled,
.file:hover {
  background: #003f9e;
}

.file {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
}

.file input {
  display: none;
}

.stage {
  position: relative;
  max-height: 60vh;
  aspect-ratio: 3 / 4;
  background: #111;
  border-radius: 12px;
  overflow: hidden;
}

video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#overlayContainer {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.result {
  margin-top: .75rem;
  font-size: 1.05rem;
  padding: .5rem;
  background: #f0f0f0;
  border-radius: 6px;
}
</style>
</body>
</html>